<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bildverkstad Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tool-tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
        .project-tab.active { background-color: white; border-bottom-color: white; font-weight: 600; }
        .project-tab:not(.active) { background-color: #e5e7eb; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sticker:hover { transform: scale(1.1); }
        #undo-btn:disabled, button:disabled { opacity: 0.5; cursor: not-allowed; }
        .transparent-bg {
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row h-screen antialiased">

    <!-- Verktygspanel -->
    <aside class="w-full md:w-80 bg-white p-6 shadow-lg overflow-y-auto flex flex-col space-y-6">
        <header><h1 class="text-2xl font-bold text-indigo-600">Bildverkstad</h1><p class="text-sm text-gray-500">Dina projekt, dina regler.</p></header>

        <div id="tools-container" class="hidden flex-1 flex flex-col">
             <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto" aria-label="Tabs">
                    <button class="tool-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="add-panel">Lägg till</button>
                    <button class="tool-tab-btn text-gray-500 hover:text-gray-700 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="adjustments-panel">Justera</button>
                    <button class="tool-tab-btn text-gray-500 hover:text-gray-700 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="erase-panel">Radera</button>
                </nav>
            </div>
            
            <div class="py-4 space-y-1"><p class="text-xs text-gray-500">Redigerar nu:</p><p id="editing-status" class="font-semibold text-indigo-600 text-sm">Inget aktivt lager</p></div>
            
            <div id="add-panel" class="tool-panel space-y-4">
                 <h3 class="text-lg font-semibold border-b pb-2">Lägg till lager</h3>
                 <label for="upload-add" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors cursor-pointer flex items-center justify-center shadow">Lägg till bild från fil</label>
                 <input type="file" id="upload-add" class="hidden" accept="image/*">
                 <h4 class="text-md font-semibold border-b pb-2">Text</h4>
                 <div><label for="text-input" class="block text-sm font-medium text-gray-700">Din text</label><input type="text" id="text-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Skriv något..."></div>
                 <div><label for="text-color" class="block text-sm font-medium text-gray-700">Färg</label><input type="color" id="text-color" value="#333333" class="mt-1 h-10 w-full block border cursor-pointer rounded-md"></div>
                 <button id="add-text" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">Lägg till text</button>
                 <h4 class="text-md font-semibold border-b pb-2">Klistermärken</h4>
                 <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="sticker" data-sticker="sunglasses"><svg viewBox="0 0 512 512" fill="currentColor"><path d="M448 224h-48v-80c0-44.2-35.8-80-80-80h-32c-44.2 0-80 35.8-80 80v80H64c-35.3 0-64 28.7-64 64v96c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64v-96c0-35.3-28.7-64-64-64zM256 96h32c26.5 0 48 21.5 48 48v80h-80v-80c0-26.5 21.5-48 48-48zm-128 48c0-26.5 21.5-48 48-48h32v128h-80v-80zm272 256H64c-8.8 0-16-7.2-16-16v-96c0-8.8 7.2-16 16-16h384c8.8 0 16 7.2 16 16v96c0 8.8-7.2 16-16 16z"></path></svg></div>
                    <div class="sticker" data-sticker="heart"><svg viewBox="0 0 512 512" fill="crimson"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg></div>
                    <div class="sticker" data-sticker="star"><svg viewBox="0 0 512 512" fill="gold"><path d="M256 16l-64 192h-192l160 128-64 192 160-128 160 128-64-192 160-128h-192z"></path></svg></div>
                </div>
            </div>
            
            <div id="adjustments-panel" class="tool-panel hidden space-y-6">
                <h3 class="text-lg font-semibold border-b pb-2">Färgjusteringar</h3>
                <div class="space-y-4">
                    <div><label for="brightness" class="block text-sm font-medium text-gray-700 mb-1">Ljusstyrka</label><input type="range" id="brightness" min="0" max="200" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>
                    <div><label for="contrast" class="block text-sm font-medium text-gray-700 mb-1">Kontrast</label><input type="range" id="contrast" min="0" max="200" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>
                    <div><label for="saturation" class="block text-sm font-medium text-gray-700 mb-1">Mättnad</label><input type="range" id="saturation" min="0" max="200" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>
                </div>
                <h3 class="text-lg font-semibold border-b pb-2">Filter</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button class="filter-btn border p-2 rounded-lg hover:bg-gray-100" data-filter="grayscale">Svartvitt</button>
                    <button class="filter-btn border p-2 rounded-lg hover:bg-gray-100" data-filter="sepia">Sepia</button>
                    <button class="filter-btn border p-2 rounded-lg hover:bg-gray-100" data-filter="vintage">Vintage</button>
                </div>
                <button id="reset-filters" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Återställ filter</button>
            </div>

            <div id="erase-panel" class="tool-panel hidden space-y-4">
                <h3 class="text-lg font-semibold border-b pb-2">Ta bort från lager</h3>
                <div><label for="tolerance" class="block text-sm font-medium text-gray-700 mb-1">Tolerans: <span id="tolerance-value">20</span></label><input type="range" id="tolerance" min="0" max="150" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><p class="text-xs text-gray-500 mt-1">Klicka på en färg för att göra den genomskinlig.</p></div>
                <div><label for="brush-size" class="block text-sm font-medium text-gray-700 mb-1">Penselstorlek: <span id="brush-size-value">20</span></label><input type="range" id="brush-size" min="1" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><p class="text-xs text-gray-500 mt-1">Håll ner musknappen och måla för att radera.</p></div>
                 <button id="delete-layer-btn" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Radera markerat lager</button>
            </div>
        </div>
        
        <div id="export-panel" class="hidden space-y-2 pt-4 border-t mt-auto">
             <div class="flex space-x-2"><button id="undo-btn" class="w-1/3 bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 flex items-center justify-center shadow" disabled>Ångra</button><button id="save-image" class="w-2/3 bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center shadow">Spara bild</button></div>
        </div>
    </aside>

    <main class="flex-1 bg-gray-200 flex flex-col p-4 md:p-8">
        <div class="flex items-center border-b border-gray-300 relative">
             <div id="project-tabs" class="flex items-center flex-grow overflow-x-auto"></div>
             <button id="new-project-btn" class="p-3 text-gray-600 hover:bg-gray-300 rounded-t-lg ml-2 flex-shrink-0">+</button>
             <div id="new-project-menu" class="hidden absolute top-full right-0 mt-1 bg-white shadow-lg rounded-md border py-1 z-10">
                <button id="open-image-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Öppna bild från fil...</button>
                <button id="create-blank-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Nytt tomt projekt</button>
             </div>
        </div>
        <div id="canvas-container" class="bg-white shadow-inner flex-1 w-full h-full overflow-hidden flex items-center justify-center transparent-bg">
             <div id="placeholder" class="text-center text-gray-400 p-10 bg-white rounded-lg"><h2 class="text-xl font-medium">Välkommen till Bildverkstad Studio!</h2><p>Klicka på + för att skapa ett nytt projekt.</p></div>
             <canvas id="editor-canvas" class="hidden"></canvas>
             <div id="loader" class="loader hidden"></div>
        </div>
    </main>
    <input type="file" id="new-project-image-upload" class="hidden" accept="image/*">
    
    <script>
        // DOM Elements
        const canvas = document.getElementById('editor-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const addUpload = document.getElementById('upload-add');
        const saveBtn = document.getElementById('save-image');
        const undoBtn = document.getElementById('undo-btn');
        const placeholder = document.getElementById('placeholder');
        const canvasContainer = document.getElementById('canvas-container');
        const editingStatus = document.getElementById('editing-status');
        const toolsContainer = document.getElementById('tools-container');
        const exportPanel = document.getElementById('export-panel');
        const projectTabsContainer = document.getElementById('project-tabs');
        const newProjectBtn = document.getElementById('new-project-btn');
        const newProjectMenu = document.getElementById('new-project-menu');
        const openImageBtn = document.getElementById('open-image-btn');
        const createBlankBtn = document.getElementById('create-blank-btn');
        const newProjectImageUpload = document.getElementById('new-project-image-upload');
        const deleteLayerBtn = document.getElementById('delete-layer-btn');
        
        const brightnessSlider = document.getElementById('brightness'), contrastSlider = document.getElementById('contrast'), saturationSlider = document.getElementById('saturation');
        const resetFiltersBtn = document.getElementById('reset-filters'), filterBtns = document.querySelectorAll('.filter-btn');
        const addTextBtn = document.getElementById('add-text'), textInput = document.getElementById('text-input'), textColorInput = document.getElementById('text-color');
        const stickerBtns = document.querySelectorAll('.sticker');
        const toleranceSlider = document.getElementById('tolerance'), toleranceValue = document.getElementById('tolerance-value');
        const brushSizeSlider = document.getElementById('brush-size'), brushSizeValue = document.getElementById('brush-size-value');
        const toolTabBtns = document.querySelectorAll('.tool-tab-btn');

        // App State
        let projects = [];
        let activeProjectId = null;
        let isDrawing = false;
        
        // --- Project Factory ---
        function createProject(name, image = null) {
            const id = Date.now();
            return {
                id, name, image,
                baseCanvas: document.createElement('canvas'),
                layers: [],
                filters: { brightness: 100, contrast: 100, saturate: 100, grayscale: 0, sepia: 0 },
                history: [], historyIndex: -1, activeLayerId: null
            };
        }

        // --- Event Listeners ---
        newProjectBtn.addEventListener('click', (e) => { e.stopPropagation(); newProjectMenu.classList.toggle('hidden'); });
        openImageBtn.addEventListener('click', () => { newProjectImageUpload.click(); newProjectMenu.classList.add('hidden'); });
        createBlankBtn.addEventListener('click', () => { openNewProject("Projekt " + (projects.length + 1), null); newProjectMenu.classList.add('hidden'); });
        document.addEventListener('click', (e) => { if (!newProjectBtn.contains(e.target) && !newProjectMenu.contains(e.target)) { newProjectMenu.classList.add('hidden'); } });

        newProjectImageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            openNewProject(file.name, file);
            e.target.value = null;
        });
        
        addUpload.addEventListener('change', e => handleAddLayer(e.target.files[0], 'image'));
        stickerBtns.forEach(btn => btn.addEventListener('click', () => {
            const svgElement = btn.querySelector('svg').outerHTML;
            handleAddLayer('data:image/svg+xml;base64,' + btoa(svgElement), 'sticker');
        }));
        addTextBtn.addEventListener('click', () => handleAddLayer(textInput.value, 'text'));

        saveBtn.addEventListener('click', saveActiveProject);
        undoBtn.addEventListener('click', undo);
        deleteLayerBtn.addEventListener('click', deleteActiveLayer);

        [brightnessSlider, contrastSlider, saturationSlider].forEach(s => { s.addEventListener('input', applyAllFilters); s.addEventListener('change', saveState); });
        resetFiltersBtn.addEventListener('click', () => { resetAllFilters(true); saveState(); });
        filterBtns.forEach(btn => btn.addEventListener('click', () => { applyPresetFilter(btn.dataset.filter); saveState(); }));
        
        toleranceSlider.addEventListener('input', () => toleranceValue.textContent = toleranceSlider.value);
        brushSizeSlider.addEventListener('input', () => brushSizeValue.textContent = brushSizeSlider.value);

        toolTabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                toolTabBtns.forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tool-panel').forEach(p => p.classList.add('hidden'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.target).classList.remove('hidden');
                canvas.style.cursor = getActiveToolTab() === 'erase-panel' ? 'crosshair' : 'default';
            });
        });

        canvas.addEventListener('mousedown', handleCanvasMouseDown);
        canvas.addEventListener('mousemove', handleCanvasMouseMove);
        canvas.addEventListener('mouseup', handleCanvasMouseUp);
        canvas.addEventListener('mouseleave', handleCanvasMouseUp);
        window.addEventListener('resize', () => setActiveProject(activeProjectId, true));


        // --- Project Management ---
        function openNewProject(name, file) {
            const project = createProject(name, file);
            projects.push(project);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        project.image = img;
                        setActiveProject(project.id, true);
                        saveState();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                setActiveProject(project.id, true);
                saveState();
            }
        }
        
        function setActiveProject(id, forceResize = false) {
            if (activeProjectId === id && !forceResize) return;
            
            if (!id && projects.length > 0) {
                id = projects[projects.length - 1].id;
            }
            activeProjectId = id;
            const project = getActiveProject();

            if (!project) {
                placeholder.classList.remove('hidden');
                toolsContainer.classList.add('hidden');
                exportPanel.classList.add('hidden');
                canvas.classList.add('hidden');
                renderTabs();
                return;
            };
            
            placeholder.classList.add('hidden');
            toolsContainer.classList.remove('hidden');
            exportPanel.classList.remove('hidden');
            canvas.classList.remove('hidden');
            
            const containerWidth = canvasContainer.clientWidth;
            const containerHeight = canvasContainer.clientHeight;
            
            if (project.image) {
                const imgWidth = project.image.width;
                const imgHeight = project.image.height;
                const containerAspectRatio = containerWidth / containerHeight;
                const imgAspectRatio = imgWidth / imgHeight;
                let finalWidth, finalHeight;

                if (imgAspectRatio > containerAspectRatio) {
                    finalWidth = containerWidth;
                    finalHeight = containerWidth / imgAspectRatio;
                } else {
                    finalHeight = containerHeight;
                    finalWidth = containerHeight * imgAspectRatio;
                }

                canvas.width = project.baseCanvas.width = finalWidth;
                canvas.height = project.baseCanvas.height = finalHeight;
                project.baseCanvas.getContext('2d').drawImage(project.image, 0, 0, finalWidth, finalHeight);

            } else {
                 canvas.width = project.baseCanvas.width = containerWidth * 0.9;
                 canvas.height = project.baseCanvas.height = containerHeight * 0.9;
                 project.baseCanvas.getContext('2d').clearRect(0,0, canvas.width, canvas.height);
            }

            renderTabs();
            updateUI();
        }
        
        function renderTabs() {
            projectTabsContainer.innerHTML = '';
            projects.forEach(p => {
                const tab = document.createElement('button');
                tab.className = `project-tab p-3 text-sm border-b-2 whitespace-nowrap ${p.id === activeProjectId ? 'active' : ''}`;
                const titleSpan = document.createElement('span');
                titleSpan.textContent = p.name.substring(0, 15) + (p.name.length > 15 ? '...' : '');
                
                const closeBtn = document.createElement('span');
                closeBtn.innerHTML = '&times;';
                closeBtn.className = 'ml-2 font-bold hover:text-red-500';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeProject(p.id);
                };
                
                tab.appendChild(titleSpan);
                tab.appendChild(closeBtn);
                tab.onclick = () => setActiveProject(p.id);
                projectTabsContainer.appendChild(tab);
            });
        }

        function closeProject(id) {
            projects = projects.filter(p => p.id !== id);
            if (activeProjectId === id) {
                activeProjectId = projects.length > 0 ? projects[projects.length - 1].id : null;
                setActiveProject(activeProjectId, true);
            }
             renderTabs();
        }

        function getActiveProject() { return projects.find(p => p.id === activeProjectId); }
        function getActiveLayer() {
            const project = getActiveProject();
            if (!project || !project.activeLayerId) return null;
            return project.layers.find(l => l.id === project.activeLayerId);
        }

        function handleAddLayer(source, type) {
            const project = getActiveProject();
            if (!project) return;
            const layerId = Date.now();
            let newLayer;
            if (type === 'image' || type === 'sticker') {
                const img = new Image();
                img.onload = () => {
                    const layerCanvas = document.createElement('canvas');
                    layerCanvas.width = img.width;
                    layerCanvas.height = img.height;
                    layerCanvas.getContext('2d').drawImage(img, 0, 0);
                    const scale = type === 'sticker' ? (canvas.width / 10) / img.width : Math.min((canvas.width / 2) / img.width, (canvas.height / 2) / img.height);
                    newLayer = { id: layerId, type: 'image', canvas: layerCanvas, x: 20, y: 20, width: img.width * scale, height: img.height * scale, filters: { brightness: 100, contrast: 100, saturate: 100, grayscale: 0, sepia: 0 }};
                    project.layers.push(newLayer);
                    project.activeLayerId = layerId;
                    saveState();
                };
                if (type === 'image') { const reader = new FileReader(); reader.onload = e => img.src = e.target.result; reader.readAsDataURL(source); } 
                else { img.src = source; }
            } else if (type === 'text') {
                if (!source) return;
                newLayer = { id: layerId, type: 'text', text: source, color: textColorInput.value, font: 'bold 48px Inter', x: 30, y: 60 };
                ctx.font = newLayer.font;
                newLayer.width = ctx.measureText(newLayer.text).width;
                newLayer.height = 48;
                project.layers.push(newLayer);
                project.activeLayerId = layerId;
                textInput.value = '';
                saveState();
            }
        }
        
        function deleteActiveLayer(){
            const project = getActiveProject();
            const layer = getActiveLayer();
            if(!project || !layer) return;
            project.layers = project.layers.filter(l => l.id !== layer.id);
            project.activeLayerId = null;
            saveState();
        }

        function updateUI() {
            const project = getActiveProject();
            if (!project) return;
            const layer = getActiveLayer();
            const target = layer || project;
            const filters = target.filters;
            const canAdjust = !layer || layer.type === 'image';
            document.querySelector("#adjustments-panel").style.opacity = canAdjust ? 1 : 0.5;
            if (canAdjust) {
                brightnessSlider.value = filters.brightness;
                contrastSlider.value = filters.contrast;
                saturationSlider.value = filters.saturate;
            }
            editingStatus.textContent = !layer ? 'Basbild' : (layer.type === 'image' ? `Bildlager #${project.layers.indexOf(layer)+1}` : 'Textlager');
            undoBtn.disabled = project.historyIndex <= 0;
            deleteLayerBtn.style.display = layer ? 'block' : 'none';
            redrawCanvas();
        }

        function redrawCanvas() {
            const project = getActiveProject();
            if (!project) { canvas.classList.add('hidden'); placeholder.classList.remove('hidden'); return; }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.filter = buildFilterString(project.filters);
            ctx.drawImage(project.baseCanvas, 0, 0);
            ctx.filter = 'none';
            project.layers.forEach(layer => {
                if (layer.type === 'image') {
                    ctx.filter = buildFilterString(layer.filters);
                    ctx.drawImage(layer.canvas, layer.x, layer.y, layer.width, layer.height);
                    ctx.filter = 'none';
                } else if (layer.type === 'text') {
                    ctx.font = layer.font;
                    ctx.fillStyle = layer.color;
                    ctx.textBaseline = 'top';
                    ctx.fillText(layer.text, layer.x, layer.y);
                }
                if (project.activeLayerId === layer.id) {
                    ctx.strokeStyle = '#4f46e5';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(layer.x - 2, layer.y - 2, layer.width + 4, layer.height + 4);
                }
            });
        }
        function buildFilterString(f) { return `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturate}%) grayscale(${f.grayscale}) sepia(${f.sepia})`; }

        function getMousePos(evt) { const rect = canvas.getBoundingClientRect(); return { x: evt.clientX - rect.left, y: evt.clientY - rect.top }; }

        function handleCanvasMouseDown(e) {
            const project = getActiveProject();
            if (!project) return;
            const pos = getMousePos(e);
            if (getActiveToolTab() === 'erase-panel') {
                isDrawing = true;
                eraseAt(pos.x, pos.y);
                return;
            }
            let layerClicked = false;
            for (let i = project.layers.length - 1; i >= 0; i--) {
                const l = project.layers[i];
                if (pos.x > l.x && pos.x < l.x + l.width && pos.y > l.y && pos.y < l.y + l.height) {
                    project.activeLayerId = l.id;
                    l.isDragging = true;
                    l.lastX = pos.x;
                    l.lastY = pos.y;
                    layerClicked = true;
                    canvas.style.cursor = 'grabbing';
                    break;
                }
            }
            if (!layerClicked) project.activeLayerId = null;
            updateUI();
        }

        function handleCanvasMouseMove(e) {
            const project = getActiveProject();
            if (!project) return;
            const pos = getMousePos(e);
            const layer = getActiveLayer();
            if (isDrawing && getActiveToolTab() === 'erase-panel') { eraseAt(pos.x, pos.y); return; }
            if (layer && layer.isDragging) {
                layer.x += pos.x - layer.lastX;
                layer.y += pos.y - layer.lastY;
                layer.lastX = pos.x;
                layer.lastY = pos.y;
                redrawCanvas();
            } else if (getActiveToolTab() !== 'erase-panel') {
                 canvas.style.cursor = project.layers.some(l => pos.x > l.x && pos.x < l.x + l.width && pos.y > l.y && pos.y < l.y + l.height) ? 'pointer' : 'default';
            }
        }
        
        function handleCanvasMouseUp() {
            const layer = getActiveLayer();
            if (isDrawing || (layer && layer.isDragging)) { saveState(); }
            if (layer) layer.isDragging = false;
            isDrawing = false;
            if (getActiveToolTab() !== 'erase-panel') canvas.style.cursor = 'default';
        }

        function applyAllFilters() {
            const project = getActiveProject(); if(!project) return; const layer = getActiveLayer();
            const target = (layer && layer.type === 'image') ? layer : project;
            target.filters.brightness = parseFloat(brightnessSlider.value);
            target.filters.contrast = parseFloat(contrastSlider.value);
            target.filters.saturate = parseFloat(saturationSlider.value);
            redrawCanvas();
        }
        function applyPresetFilter(filterType) { 
            const project = getActiveProject(); if(!project) return; const layer = getActiveLayer();
            const target = (layer && layer.type === 'image') ? layer : project;
            if(layer && layer.type === 'text') return;
            resetAllFilters(false);
            if (filterType === 'grayscale') target.filters.grayscale = target.filters.grayscale === 1 ? 0 : 1;
            else if (filterType === 'sepia') target.filters.sepia = target.filters.sepia === 1 ? 0 : 1;
            else if (filterType === 'vintage') { Object.assign(target.filters, {sepia: 0.5, contrast: 120, brightness: 110, saturate: 120}); }
            updateUI();
        }
        function resetAllFilters(redraw) { 
            const project = getActiveProject(); if(!project) return; const layer = getActiveLayer();
            const target = (layer && layer.type === 'image') ? layer : project;
            if(layer && layer.type === 'text') return;
            Object.assign(target.filters, { brightness: 100, contrast: 100, saturate: 100, grayscale: 0, sepia: 0 });
            if(redraw) updateUI();
        }

        function eraseAt(x, y) {
            const project = getActiveProject(); if(!project) return; const layer = getActiveLayer();
            const target = layer || project; if (target.type === 'text') return;
            const targetCanvas = target.baseCanvas || target.canvas; const targetCtx = targetCanvas.getContext('2d');
            const brushSize = parseInt(brushSizeSlider.value);
            const tX = layer ? (x - layer.x) * (targetCanvas.width / layer.width) : x;
            const tY = layer ? (y - layer.y) * (targetCanvas.height / layer.height) : y;
            targetCtx.save();
            targetCtx.globalCompositeOperation = 'destination-out';
            targetCtx.beginPath();
            targetCtx.arc(tX, tY, brushSize, 0, Math.PI * 2);
            targetCtx.fill();
            targetCtx.restore();
            redrawCanvas();
        }
        
        // --- History ---
        function cloneCanvas(oldCanvas) {
            let newCanvas = document.createElement('canvas');
            newCanvas.width = oldCanvas.width;
            newCanvas.height = oldCanvas.height;
            newCanvas.getContext('2d').drawImage(oldCanvas, 0, 0);
            return newCanvas;
        }
        function saveState() {
            const project = getActiveProject(); if (!project) return;
            const state = {
                baseCanvas: cloneCanvas(project.baseCanvas),
                layers: JSON.parse(JSON.stringify(project.layers, (k,v) => k === 'canvas' ? undefined : v)),
                filters: { ...project.filters }, activeLayerId: project.activeLayerId
            };
            state.layers.forEach((layer, index) => { if (project.layers[index].type === 'image') layer.canvas = cloneCanvas(project.layers[index].canvas); });
            project.history = project.history.slice(0, project.historyIndex + 1);
            project.history.push(state);
            project.historyIndex++;
            updateUI();
        }
        function undo() {
            const project = getActiveProject();
            if (project && project.historyIndex > 0) {
                project.historyIndex--;
                loadState(project.history[project.historyIndex]);
            }
        }
        function loadState(state) {
            const project = getActiveProject(); if (!project) return;
            project.baseCanvas = cloneCanvas(state.baseCanvas);
            project.filters = { ...state.filters };
            project.layers = JSON.parse(JSON.stringify(state.layers, (k,v) => k === 'canvas' ? undefined : v));
            project.layers.forEach((layer, index) => { if (state.layers[index].type === 'image') layer.canvas = cloneCanvas(state.layers[index].canvas); });
            project.activeLayerId = state.activeLayerId;
            updateUI();
        }
        
        function saveActiveProject() {
            const project = getActiveProject(); if(!project) return;
            project.activeLayerId = null; redrawCanvas();
            const link = document.createElement('a');
            link.download = project.name.replace(/\.[^/.]+$/, "") + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            updateUI();
        }
        function getActiveToolTab() { return document.querySelector('.tool-tab-btn.active')?.dataset.target; }
    </script>
</body>
</html>
